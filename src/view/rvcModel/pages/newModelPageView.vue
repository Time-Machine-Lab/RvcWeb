<script lang="ts" setup>
import TagSelectComponent from '@/components/common/tagSelectComponent.vue';
import ModelEditorComponent from '@/components/editor/modelEditorComponent.vue';
import { ModelAddForm, UpdateModelForm } from '@/api/rvcModel/modelType'
import { getModelDetails, getModelLabel, modelAdd, updateModel } from '@/api/rvcModel/modelApi'
import { uploadImages } from '@/api/rvcModel/fileApi.ts'
import { ref } from 'vue';
import { message } from '@/utils/message';
import router from '@/router';
// import { UploadInstance } from 'element-plus/es/components/upload/src/upload';
let typeOptions = ref(['RVC'])
let typeSelectvisibility = ref(false)
let clickType = ref(false)
let currentTypeIndex = ref(0)
// let uploadModelLoading = ref(false)
let uploadCoverLoading = ref(false)
let modelAddForm = ref<ModelAddForm>({
    description: '',
    label: [],
    name: '',
    note: '',
    picture: '',
    typeId: 'RVC',
    fileUrl: ''
})
let updateModelForm = ref<UpdateModelForm>({
    id: '',
    name: '',
    description: '',
    note: '',
    picture: ''
})
let process = ref<{
    current: number
}>({
    current: 1
})
let options = ref<{
    value: string,
    label: string
}[]>([])
let submitDisabled = ref(false)
let isEdit = ref(false)
if (router.currentRoute.value.path == '/editModel')
    isEdit.value = true
else
    modelAddForm.value.description = ''
if (isEdit.value) {
    getModelDetails(router.currentRoute.value.query.id as string).then((res: any) => {
        if (res.code == 200) {
            modelAddForm.value = res.data
        } else {
            message.error(res.msg)
        }
    })
}
getModelLabel({
    page: '1',
    limit: '20'
}).then((res: any) => {
    if (res.code == 200) {
        let data: any = res.data
        for (let i = 0; i < data.length; i++) {
            options.value.push({
                value: data[i].id,
                label: data[i].name
            })
        }
    } else {
        message.error(res.msg)
    }
})
let formWarning = ref<{
    name: boolean,
    typeId: boolean,
    description: boolean,
    label: boolean,
    fileUrl: boolean,
    note: boolean
}>({
    name: false,
    typeId: false,
    description: false,
    label: false,
    fileUrl: false,
    note: false
})
const handleClickSort = function () {
    clickType.value = true
    typeSelectvisibility.value = !typeSelectvisibility.value
    setTimeout(function () {
        clickType.value = false
    }, 200)
}
const handleBlur = function () {
    setTimeout(function () {
        typeSelectvisibility.value = false
    }, 200)
}
const getContent = function (html: string) {
    modelAddForm.value.description = html
}
const nextStep = function () {
    if (process.value.current == 1) {
        if (modelAddForm.value.name == '') {
            formWarning.value.name = true
        }
        if (modelAddForm.value.typeId == '') {
            formWarning.value.typeId = true
        }
        if (modelAddForm.value.description == '<p><br></p>') {
            formWarning.value.description = true
        }
        if (modelAddForm.value.note == '') {
            formWarning.value.note = true
        }
        if (!isEdit.value == true) {
            if (modelAddForm.value.label.length == 0) {
                formWarning.value.label = true
            }
        }
        setTimeout(() => {
            formWarning.value.name = false
            formWarning.value.typeId = false
            formWarning.value.description = false
            formWarning.value.label = false
            formWarning.value.note = false
        }, 1000)
        if (formWarning.value.name || formWarning.value.typeId || formWarning.value.description || formWarning.value.label || formWarning.value.note) return
        process.value.current = process.value.current + 1
    } else if (process.value.current == 2) {
        if (modelAddForm.value.fileUrl == '') {
            message.warning('请填写下载链接')
            formWarning.value.fileUrl = true
            return
        }
        process.value.current = process.value.current + 1

    }

}
const lastStep = function () {
    if (process.value.current != 0) {
        process.value.current = process.value.current - 1
    }
}
// const handleModelFileSuccess = function () { };
// const beforeModelFileUpload = function (rawFile: File) {
//     modelFiles.push(rawFile)
//     if (modelFiles.length == 2)
//         // uploadModelFile()
//     return false
// };

const handleCoverSuccess = function () { };
let imageType = ['image/jpeg','image/png','image/gif']
const beforeCoverUpload = function (rawFile: File) {
    if ((rawFile.size / ( 1024)) > 256) {
        message.warning('请上传小于256KB的图片')
        return false
    }
    if (!imageType.includes(rawFile.type)) {
        message.error('文件不合法')
        return false
    }
    uploadCoverLoading.value = true
    uploadImages(rawFile).then((res: any) => {
        if (res.code == 200) {
            modelAddForm.value.picture = res.data.url
            message.success('封面上传成功')
        } else {
            message.error(res.message)
        }
        uploadCoverLoading.value = false
    })
    return false
};
// const uploadModelRef = ref<UploadInstance>()
// const handleUpload = function () {
//     modelFiles = []
//     uploadModelRef?.value?.submit()
// }
const getValue = function (value: string[]) {
    console.log(value);

    modelAddForm.value.label = []
    for (let i = 0; i < value.length; i++) {
        modelAddForm.value.label.push(value[i])
    }

}
const uploadFinish = function () {
    return modelAddForm.value.fileUrl != ""
    // return modelAddForm.value.fileId.length == 2 && modelAddForm.value.audioId != ""
}
const handleExceed = function () {
    message.warning('超出数量上限')
}
const beforeRemove = function () {
    return true
}
const submit = function () {
    if (submitDisabled.value) return
    submitDisabled.value = true
    modelAddForm.value.typeId = "1734224118915072002"
    if (isEdit.value == true) {
        updateModelForm.value.id = modelAddForm.value.id
        updateModelForm.value.description = modelAddForm.value.description
        updateModelForm.value.name = modelAddForm.value.name
        updateModelForm.value.note = modelAddForm.value.note
        updateModelForm.value.picture = modelAddForm.value.picture
        updateModel(updateModelForm.value).then((res: any) => {
            if (res.code == 200) {
                message.success('修改成功')
                router.back()
            } else {
                submitDisabled.value = false
                message.error(res.message)
            }
        })

    } else {
        modelAdd(modelAddForm.value).then((res: any) => {
            if (res.code == 200) {
                message.success('发布成功')
                router.back()
            } else {
                submitDisabled.value = false
                message.error(res.message)
            }
        })
    }

}
// let modelFiles: any = []
</script>
<template>
    <div class="scroll-container">
        <div class="new-model">
            <div class="new-model__title">
                {{ isEdit ? '编辑' : '上传' }}模型
            </div>
            <div class="new-model__process">
                <div class="new-model__process__ball"
                    :style="{ border: process.current == 1 ? 'rgba(25,113,194) 2px solid' : '', backgroundColor: process.current > 1 ? 'rgba(25,113,194)' : '' }">
                    1</div>
                <div class="new-model__process__desc">
                    模型信息
                </div>
                <div class="new-model__process__dash"></div>
                <div class="new-model__process__ball"
                    :style="{ border: process.current == 2 ? 'rgba(25,113,194) 2px solid' : '', backgroundColor: process.current > 2 ? 'rgba(25,113,194)' : '' }">
                    2</div>
                <div class="new-model__process__desc">
                    上传文件
                </div>
                <div class="new-model__process__dash"></div>
                <div class="new-model__process__ball"
                    :style="{ border: process.current == 3 ? 'rgba(25,113,194) 2px solid' : '', backgroundColor: process.current > 3 ? 'rgba(25,113,194)' : '' }">
                    3</div>
                <div class="new-model__process__desc">
                    提交
                </div>
            </div>
            <div v-show="process.current == 1">
                <div class="new-model__title">
                    模型信息
                </div>
                <span class="label">模型名称<span class="important">*</span></span>
                <input class="input" placeholder="模型名称" v-model="modelAddForm.name"
                    :class="formWarning.name ? 'formWarning' : 'formDefault'">

                <span class="label">模型类型<span class="important">*</span></span>
                <div class="select">
                    <div tabindex="-1" class="type-selecter"
                        :style="{ border: typeSelectvisibility ? 'rgba(24,100,171) 1px solid' : '' }"
                        :class="[clickType ? 'dither-animation' : '']" @click="handleClickSort" @blur="handleBlur">
                        <div class="horizontal-center" :class="formWarning.typeId ? 'formWarning' : 'formDefault'"
                            style="width:100%;display: flex;">
                            <span style="position: relative;left:0%;line-height: 35px;width:97%;text-align: left;">{{
                                typeOptions[currentTypeIndex] }}</span>
                            <span style="position: relative;right:0%;">
                                <img width="14" height="14" class="vertical-center" style="transition: all 0.2s;"
                                    :class="typeSelectvisibility ? 'revolve-animation' : ''" src="/icon/arrow-down.svg">
                            </span>
                        </div>

                    </div>
                    <div class="type-select" v-show="typeSelectvisibility">
                        <div class="type-select__item" v-for="(tag, index) in typeOptions" :key="index"
                            @click="currentTypeIndex = index; typeSelectvisibility = false; modelAddForm.typeId = tag"
                            :style="{ backgroundColor: currentTypeIndex == index ? 'rgba(24,100,171)' : '' }">
                            {{ tag }}
                        </div>
                    </div>

                </div>
                <span class="label" v-if="!isEdit">标签<span class="important">*</span></span>
                <div :class="formWarning.label ? 'formWarning' : 'formDefault'"
                    style="width: fit-content;border-radius: 5px;">
                    <TagSelectComponent v-if="!isEdit" :options="options" :get-value="getValue" :value="modelAddForm.label">
                    </TagSelectComponent>
                </div>

                <span class="label" style="margin-top: 20px;">介绍<span class="important">*</span></span>
                <div :class="formWarning.description ? 'formWarning' : 'formDefault'">
                    <ModelEditorComponent :get-content="getContent" v-if="(isEdit && modelAddForm.description) || (!isEdit)"
                        :editorContent="modelAddForm.description"></ModelEditorComponent>
                </div>

                <span class="label" style="margin-top: 20px;">注意事项<span class="important">*</span></span>
                <input class="input" placeholder="注意事项" v-model="modelAddForm.note"
                    :class="formWarning.note ? 'formWarning' : 'formDefault'">
                <div class="button-group">
                    <div class="button-group__item" @click="lastStep"
                        :style="{ visibility: process.current > 1 ? 'visible' : 'hidden' }">
                        上一步
                    </div>
                    <div class="button-group__item" @click="nextStep">
                        下一步
                    </div>
                </div>
            </div>
            <div v-show="process.current >= 2">
                <span class="label">模型下载链接<span class="important">*</span></span>
                <input class="input" placeholder="模型下载链接" v-model="modelAddForm.fileUrl">
                <!-- <div class="new-model__title">
                上传模型文件
            </div>
            <el-upload ref="uploadModelRef" class="upload-demo" drag :auto-upload="true" :limit="2"
                :on-success="handleModelFileSuccess" :before-upload="beforeModelFileUpload" :before-remove="beforeRemove"
                multiple>
                <div class="loadding" v-if="uploadModelLoading"></div>

                <div class="success" v-else-if="modelAddForm.fileId.length == 2">✓</div>
                <div class="error" v-else>×</div>
                <div class="el-upload__text">
                    将文件拖拽到此处或点击上传
                </div>
                <div class="el-upload__text">
                    提示：上传.pth与.index文件
                </div>
            </el-upload>

            <div class="new-model__title">
                上传试听音频
            </div>
            <el-upload ref="uploadAudioRef" class="upload-demo" drag :auto-upload="true" :limit="1"
                :on-exceed="handleExceed" :on-success="handleAudioFileSuccess" :before-upload="beforeAudioFileUpload"
                :before-remove="beforeRemove" multiple>
                <div class="loadding" v-if="uploadAudioLoading"></div>
                <div class="success" v-else-if="modelAddForm.picture">✓</div>
                <div class="error" v-else>×</div>
                <div class="el-upload__text">
                    将文件拖拽到此处或点击上传
                </div>
                <div class="el-upload__text">
                    最多可上传1个文件
                </div>
            </el-upload> -->

                <el-upload ref="uploadCoverRef" class="upload-demo" drag :auto-upload="true" :limit="1"
                    :on-exceed="handleExceed" :on-success="handleCoverSuccess" :before-upload="beforeCoverUpload"
                    :before-remove="beforeRemove" multiple>
                    <div class="loadding" v-if="uploadCoverLoading"></div>
                    <img :src="modelAddForm.picture" style="width: 100%;">
                    <div class="el-upload__text" v-if="modelAddForm.picture == ''">
                        将文件拖拽到此处或点击上传
                    </div>
                    <div class="el-upload__text" v-if="modelAddForm.picture == ''">
                        可上传小于256KB的封面
                        支持jpg、png、jpeg格式
                    </div>
                </el-upload>
                <div class="button-group">
                    <div class="button-group__item" @click="lastStep"
                        :style="{ visibility: process.current > 1 ? 'visible' : 'hidden' }">
                        上一步
                    </div>
                    <div class="button-group__item" v-if="uploadFinish() && process.current != 3" @click="nextStep">
                        下一步
                    </div>
                    <div class="button-group__item" v-if="process.current == 3" @click="submit">
                        提交
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
<style scoped>
@import "@/view/rvcModel/style/newModel.css";
</style>